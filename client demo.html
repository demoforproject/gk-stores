<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISTAS | My Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary: #818cf8;
            --accent: #c084fc;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 25px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header i { font-size: 3rem; color: var(--primary); margin-bottom: 10px; }
        
        input {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: white;
            outline: none;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); background: rgba(255,255,255,0.12); }

        button {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        button:active { transform: scale(0.97); }

        .hidden { display: none !important; }
        
        .user-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
        }

        .balance-amt { font-size: 2.2rem; font-weight: 700; margin: 5px 0; color: #fff; }
        
        .transaction-list { height: 320px; overflow-y: auto; margin-top: 15px; }

        .tx-item {
            background: rgba(255,255,255,0.04);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tx-info p { font-size: 0.85rem; font-weight: 600; }
        .tx-info span { font-size: 0.7rem; opacity: 0.5; }
        .tx-amt { font-weight: 700; font-size: 0.9rem; }

        #reader { width: 100%; border-radius: 18px; overflow: hidden; margin-bottom: 15px; border: 2px solid var(--primary); }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-login">
            <div class="login-header">
                <i class="fas fa-shield-halved"></i>
                <h2>VISTAS Client</h2>
                <p style="opacity:0.6; font-size: 0.8rem;">Secure Ledger Access</p>
            </div>
            
            <div id="reader" class="hidden"></div>
            <button id="btn-scan" onclick="startScanner()" style="background: #1e293b; margin-bottom: 15px;">
                <i class="fas fa-qrcode"></i> Scan My ID Card
            </button>

            <input type="text" id="login-id" placeholder="Account ID (V-XXXX)">
            <input type="password" id="login-pass" placeholder="Birth Year (YYYY)">
            <button onclick="manualLogin()">Sign In</button>
        </div>

        <div id="view-dash" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h4 id="display-name">User Name</h4>
                <i class="fas fa-power-off" onclick="location.reload()" style="cursor:pointer; color: #f87171;"></i>
            </div>

            <div class="user-card">
                <p style="font-size: 0.7rem; opacity: 0.6;">OUTSTANDING BALANCE</p>
                <h1 class="balance-amt" id="display-balance">₹0</h1>
                <small id="display-id" style="opacity: 0.5; font-family: monospace;"></small>
            </div>

            <button onclick="downloadPDF()" style="background: #ffffff; color: #000; margin-bottom: 20px; font-size: 0.8rem;">
                <i class="fas fa-file-pdf"></i> Download Statement
            </button>

            <div class="transaction-list" id="tx-feed"></div>
        </div>
    </div>

    <script>
        let currentLoggedUser = null;
        let html5QrCode;

        function startScanner() {
            document.getElementById('reader').classList.remove('hidden');
            document.getElementById('btn-scan').classList.add('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    document.getElementById('login-id').value = decodedText;
                    html5QrCode.stop();
                    document.getElementById('reader').classList.add('hidden');
                    // AUTO-FOCUS PASS FIELD AFTER SCAN
                    document.getElementById('login-pass').focus();
                }
            );
        }

        function manualLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            const users = JSON.parse(localStorage.getItem('vpro_users')) || [];
            const user = users.find(u => u.id === id && u.dob.toString() === pass);

            if(user) {
                currentLoggedUser = user;
                loadDashboard(user);
            } else { alert("Invalid Credentials"); }
        }

        function loadDashboard(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dash').classList.remove('hidden');
            document.getElementById('display-name').innerText = user.name;
            document.getElementById('display-id').innerText = user.id;
            document.getElementById('display-balance').innerText = "₹" + user.balance;

            const logs = JSON.parse(localStorage.getItem('vpro_log')) || [];
            const userLogs = logs.filter(l => l.uid === user.id).reverse();

            const feed = document.getElementById('tx-feed');
            feed.innerHTML = userLogs.map(l => `
                <div class="tx-item">
                    <div class="tx-info">
                        <p>${l.items}</p>
                        <span>${l.date}</span>
                    </div>
                    <div class="tx-amt" style="color: ${l.amt > 0 ? '#f87171' : '#4ade80'}">
                        ${l.amt > 0 ? '+' : ''}${l.amt}
                    </div>
                </div>
            `).join('');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logs = JSON.parse(localStorage.getItem('vpro_log')) || [];
            const userLogs = logs.filter(l => l.uid === currentLoggedUser.id);

            // PDF Styling
            doc.setFontSize(22);
            doc.setTextColor(79, 70, 229); // Brand Color
            doc.text("VISTAS PRO", 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Account Statement", 14, 28);
            doc.text(`Customer: ${currentLoggedUser.name}`, 14, 38);
            doc.text(`ID: ${currentLoggedUser.id}`, 14, 43);
            doc.text(`Current Balance: Rs. ${currentLoggedUser.balance}`, 14, 48);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 53);

            const tableData = userLogs.map(l => [l.date, l.items, l.amt > 0 ? `+${l.amt}` : l.amt]);

            doc.autoTable({
                startY: 60,
                head: [['Date', 'Description', 'Amount (Rs.)']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            doc.save(`${currentLoggedUser.name}_Statement.pdf`);
        }
    </script>
</body>
</html>